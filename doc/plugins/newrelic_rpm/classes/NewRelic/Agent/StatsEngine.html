<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: NewRelic::Agent::StatsEngine</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::StatsEngine</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine_rb.html">
                vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000152">add_harvest_sampler</a>&nbsp;&nbsp;
      <a href="#M000151">add_sampler</a>&nbsp;&nbsp;
      <a href="#M000146">add_scope_stack_listener</a>&nbsp;&nbsp;
      <a href="#M000163">clear_stats</a>&nbsp;&nbsp;
      <a href="#M000162">end_transaction</a>&nbsp;&nbsp;
      <a href="#M000158">get_custom_stats</a>&nbsp;&nbsp;
      <a href="#M000159">get_stats</a>&nbsp;&nbsp;
      <a href="#M000157">get_stats_no_scope</a>&nbsp;&nbsp;
      <a href="#M000160">harvest_timeslice_data</a>&nbsp;&nbsp;
      <a href="#M000144">log</a>&nbsp;&nbsp;
      <a href="#M000155">lookup_stat</a>&nbsp;&nbsp;
      <a href="#M000156">metrics</a>&nbsp;&nbsp;
      <a href="#M000143">new</a>&nbsp;&nbsp;
      <a href="#M000150">peek_scope</a>&nbsp;&nbsp;
      <a href="#M000149">pop_scope</a>&nbsp;&nbsp;
      <a href="#M000148">push_scope</a>&nbsp;&nbsp;
      <a href="#M000147">remove_scope_stack_listener</a>&nbsp;&nbsp;
      <a href="#M000164">reset_stats</a>&nbsp;&nbsp;
      <a href="#M000145">spawn_sampler_thread</a>&nbsp;&nbsp;
      <a href="#M000161">start_transaction</a>&nbsp;&nbsp;
      <a href="#M000154">transaction_name</a>&nbsp;&nbsp;
      <a href="#M000153">transaction_name=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">POLL_PERIOD</td>
          <td>=</td>
          <td class="context-item-value">10</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">ScopeStackElement</td>
          <td>=</td>
          <td class="context-item-value">Struct.new(:name, :children_time, :deduct_call_time_from_parent)</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000143" class="method-detail">
        <a name="M000143"></a>

        <div class="method-heading">
          <a href="#M000143" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000143-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000143-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 8</span>
 8:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
 9:       <span class="ruby-ivar">@stats_hash</span> = {}
10:       <span class="ruby-ivar">@harvest_samplers</span> = []
11:       <span class="ruby-ivar">@periodic_samplers</span> = []
12:       <span class="ruby-ivar">@scope_stack_listener</span> = <span class="ruby-keyword kw">nil</span>
13:       
14:       <span class="ruby-comment cmt"># Makes the unit tests happy</span>
15:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
16:       
17:       <span class="ruby-identifier">spawn_sampler_thread</span>
18:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000152" class="method-detail">
        <a name="M000152"></a>

        <div class="method-heading">
          <a href="#M000152" class="method-signature">
          <span class="method-name">add_harvest_sampler</span><span class="method-args">(sampler)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a sampler to be invoked just before each harvest.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000152-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000152-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 100</span>
100:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_harvest_sampler</span> <span class="ruby-identifier">sampler</span>
101:       <span class="ruby-ivar">@harvest_samplers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sampler</span>
102:       <span class="ruby-identifier">sampler</span>.<span class="ruby-identifier">stats_engine</span> = <span class="ruby-keyword kw">self</span>
103:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Adding harvest time sampler: #{sampler.id.to_s}&quot;</span>
104:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000151" class="method-detail">
        <a name="M000151"></a>

        <div class="method-heading">
          <a href="#M000151" class="method-signature">
          <span class="method-name">add_sampler</span><span class="method-args">(sampler)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add an instance of <a href="Sampler.html">Sampler</a> to be invoked about
every 10 seconds on a background thread.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000151-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000151-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 93</span>
93:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_sampler</span> <span class="ruby-identifier">sampler</span>
94:       <span class="ruby-ivar">@periodic_samplers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sampler</span>
95:       <span class="ruby-identifier">sampler</span>.<span class="ruby-identifier">stats_engine</span> = <span class="ruby-keyword kw">self</span>
96:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Adding sampler #{sampler.id.to_s}&quot;</span>
97:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000146" class="method-detail">
        <a name="M000146"></a>

        <div class="method-heading">
          <a href="#M000146" class="method-signature">
          <span class="method-name">add_scope_stack_listener</span><span class="method-args">(l)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000146-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000146-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 41</span>
41:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_scope_stack_listener</span>(<span class="ruby-identifier">l</span>)
42:       <span class="ruby-identifier">fail</span> <span class="ruby-value str">&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">any?</span>
43:       <span class="ruby-ivar">@scope_stack_listener</span> =  <span class="ruby-identifier">l</span>
44:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000163" class="method-detail">
        <a name="M000163"></a>

        <div class="method-heading">
          <a href="#M000163" class="method-signature">
          <span class="method-name">clear_stats</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Remove all stats. For test code only.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000163-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000163-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 256</span>
256:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear_stats</span> 
257:       <span class="ruby-ivar">@stats_hash</span>.<span class="ruby-identifier">clear</span>
258:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000162" class="method-detail">
        <a name="M000162"></a>

        <div class="method-heading">
          <a href="#M000162" class="method-signature">
          <span class="method-name">end_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000162-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000162-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 244</span>
244:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">end_transaction</span>
245:       <span class="ruby-identifier">stack</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>]
246:       
247:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>
248:         <span class="ruby-ivar">@scope_stack_listener</span>.<span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@scope_stack_listener</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
249:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
250:       <span class="ruby-keyword kw">end</span>
251:       
252:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>] = <span class="ruby-keyword kw">nil</span>
253:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000158" class="method-detail">
        <a name="M000158"></a>

        <div class="method-heading">
          <a href="#M000158" class="method-signature">
          <span class="method-name">get_custom_stats</span><span class="method-args">(metric_name, stat_class)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This version allows a caller to pass a stat class to use
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000158-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000158-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 141</span>
141:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_custom_stats</span>(<span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">stat_class</span>)
142:       <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>]
143:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span>
144:         <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">stat_class</span>.<span class="ruby-identifier">new</span>
145:         <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>] = <span class="ruby-identifier">stats</span>
146:       <span class="ruby-keyword kw">end</span>
147:       <span class="ruby-identifier">stats</span>
148:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000159" class="method-detail">
        <a name="M000159"></a>

        <div class="method-heading">
          <a href="#M000159" class="method-signature">
          <span class="method-name">get_stats</span><span class="method-args">(metric_name, use_scope = true, scoped_metric_only = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
If use_scope is true, two chained <a
href="StatsEngine.html#M000156">metrics</a> are created, one with scope and
one without If scoped_metric_only is true, only a scoped metric is created
(used by rendering <a href="StatsEngine.html#M000156">metrics</a> which by
definition are per controller only)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000159-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000159-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">use_scope</span> = <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">scoped_metric_only</span> = <span class="ruby-keyword kw">false</span>)
153:       
154:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scoped_metric_only</span>
155:         <span class="ruby-identifier">spec</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">transaction_name</span>
156:         
157:         <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>]
158:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span>
159:           <span class="ruby-identifier">stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MethodTraceStats</span>.<span class="ruby-identifier">new</span>
160:           <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>] = <span class="ruby-identifier">stats</span>        
161:         <span class="ruby-keyword kw">end</span>
162:       <span class="ruby-keyword kw">else</span>  
163:         <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>]
164:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span>
165:           <span class="ruby-identifier">stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MethodTraceStats</span>.<span class="ruby-identifier">new</span>
166:           <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>] = <span class="ruby-identifier">stats</span>
167:         <span class="ruby-keyword kw">end</span>
168:         
169:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">use_scope</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">transaction_name</span>
170:           <span class="ruby-identifier">spec</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">transaction_name</span>
171:           
172:           <span class="ruby-identifier">scoped_stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>]
173:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scoped_stats</span>.<span class="ruby-identifier">nil?</span>
174:             <span class="ruby-identifier">scoped_stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">ScopedMethodTraceStats</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">stats</span>
175:             <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>] = <span class="ruby-identifier">scoped_stats</span>        
176:           <span class="ruby-keyword kw">end</span>
177:           
178:           <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">scoped_stats</span>
179:         <span class="ruby-keyword kw">end</span>
180:       <span class="ruby-keyword kw">end</span>
181:       
182:       <span class="ruby-identifier">stats</span>
183:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000157" class="method-detail">
        <a name="M000157"></a>

        <div class="method-heading">
          <a href="#M000157" class="method-signature">
          <span class="method-name">get_stats_no_scope</span><span class="method-args">(metric_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000157-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000157-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 130</span>
130:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-identifier">metric_name</span>)
131:       <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>]
132:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span>
133:         <span class="ruby-identifier">stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MethodTraceStats</span>.<span class="ruby-identifier">new</span>
134:         <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>] = <span class="ruby-identifier">stats</span>
135:       <span class="ruby-keyword kw">end</span>
136:       <span class="ruby-identifier">stats</span>
137:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000160" class="method-detail">
        <a name="M000160"></a>

        <div class="method-heading">
          <a href="#M000160" class="method-signature">
          <span class="method-name">harvest_timeslice_data</span><span class="method-args">(previous_timeslice_data, metric_ids)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Harvest the timeslice data. First recombine current statss with any
previously unsent <a href="StatsEngine.html#M000156">metrics</a>, clear out
stats cache, and return the current stats.
</p>
<hr size="1"></hr><p>
Note: this is not synchronized. There is still some risk in this and we
will revisit later to see if we can make this more robust without
sacrificing efficiency. +++
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000160-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000160-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 194</span>
194:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_timeslice_data</span>(<span class="ruby-identifier">previous_timeslice_data</span>, <span class="ruby-identifier">metric_ids</span>)
195:       <span class="ruby-identifier">timeslice_data</span> = {}
196:       <span class="ruby-identifier">poll</span> <span class="ruby-ivar">@harvest_samplers</span>
197:       <span class="ruby-ivar">@stats_hash</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">metric_spec</span> <span class="ruby-operator">|</span>
198:         
199:         
200:         <span class="ruby-comment cmt"># get a copy of the stats collected since the last harvest, and clear</span>
201:         <span class="ruby-comment cmt"># the stats inside our hash table for the next time slice.</span>
202:         <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_spec</span>]
203: 
204:         <span class="ruby-comment cmt"># we have an optimization for unscoped metrics</span>
205:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">metric_spec</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>)
206:           <span class="ruby-identifier">metric_spec</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">metric_spec</span>
207:         <span class="ruby-keyword kw">end</span>
208: 
209:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span> 
210:           <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Nil stats for #{metric_spec.name} (#{metric_spec.scope})&quot;</span>
211:         <span class="ruby-keyword kw">end</span>
212:         
213:         <span class="ruby-identifier">stats_copy</span> = <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">clone</span>
214:         <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">reset</span>
215:         
216:         <span class="ruby-comment cmt"># if the previous timeslice data has not been reported (due to an error of some sort)</span>
217:         <span class="ruby-comment cmt"># then we need to merge this timeslice with the previously accumulated - but not sent</span>
218:         <span class="ruby-comment cmt"># data</span>
219:         <span class="ruby-identifier">previous_metric_data</span> = <span class="ruby-identifier">previous_timeslice_data</span>[<span class="ruby-identifier">metric_spec</span>]
220:         <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">previous_metric_data</span>.<span class="ruby-identifier">stats</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">previous_metric_data</span>.<span class="ruby-identifier">nil?</span>
221:         <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">round!</span>
222:         
223:         <span class="ruby-comment cmt"># don't bother collecting and reporting stats that have zero-values for this timeslice.</span>
224:         <span class="ruby-comment cmt"># significant performance boost and storage savings.</span>
225:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">is_reset?</span>
226:           
227:           <span class="ruby-identifier">metric_spec_for_transport</span> = (<span class="ruby-identifier">metric_ids</span>[<span class="ruby-identifier">metric_spec</span>].<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">metric_spec</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
228:           
229:           <span class="ruby-identifier">metric_data</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricData</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric_spec_for_transport</span>, <span class="ruby-identifier">stats_copy</span>, <span class="ruby-identifier">metric_ids</span>[<span class="ruby-identifier">metric_spec</span>])
230:           
231:           <span class="ruby-identifier">timeslice_data</span>[<span class="ruby-identifier">metric_spec</span>] = <span class="ruby-identifier">metric_data</span>
232:         <span class="ruby-keyword kw">end</span>
233:       <span class="ruby-keyword kw">end</span>
234:       
235:       <span class="ruby-identifier">timeslice_data</span>
236:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000144" class="method-detail">
        <a name="M000144"></a>

        <div class="method-heading">
          <a href="#M000144" class="method-signature">
          <span class="method-name">log</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000144-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000144-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 20</span>
20:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">log</span>
21:       <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">log</span>
22:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000155" class="method-detail">
        <a name="M000155"></a>

        <div class="method-heading">
          <a href="#M000155" class="method-signature">
          <span class="method-name">lookup_stat</span><span class="method-args">(metric_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000155-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000155-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 123</span>
123:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lookup_stat</span>(<span class="ruby-identifier">metric_name</span>)
124:       <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_name</span>]
125:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000156" class="method-detail">
        <a name="M000156"></a>

        <div class="method-heading">
          <a href="#M000156" class="method-signature">
          <span class="method-name">metrics</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000156-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000156-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 126</span>
126:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">metrics</span>
127:       <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@stats_hash</span>.<span class="ruby-identifier">keys</span>
128:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000150" class="method-detail">
        <a name="M000150"></a>

        <div class="method-heading">
          <a href="#M000150" class="method-signature">
          <span class="method-name">peek_scope</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000150-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000150-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 87</span>
87:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peek_scope</span>
88:       <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">last</span>
89:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000149" class="method-detail">
        <a name="M000149"></a>

        <div class="method-heading">
          <a href="#M000149" class="method-signature">
          <span class="method-name">pop_scope</span><span class="method-args">(expected_scope, duration, time=Time.now.to_f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000149-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000149-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 65</span>
65:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_scope</span>(<span class="ruby-identifier">expected_scope</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>)
66: 
67:       <span class="ruby-identifier">stack</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>]
68:       
69:       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">pop</span>
70:       
71:       <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unbalanced pop from blame stack: #{scope.name} != #{expected_scope.name}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">expected_scope</span>
72:        
73:       <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">unless</span> (<span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span>)
74:       
75:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
76:         <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">children_time</span>
77:       <span class="ruby-keyword kw">end</span>
78:       
79:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@scope_stack_listener</span>
80:         <span class="ruby-ivar">@scope_stack_listener</span>.<span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>)
81:         <span class="ruby-ivar">@scope_stack_listener</span>.<span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
82:       <span class="ruby-keyword kw">end</span>
83:       
84:       <span class="ruby-identifier">scope</span>
85:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000148" class="method-detail">
        <a name="M000148"></a>

        <div class="method-heading">
          <a href="#M000148" class="method-signature">
          <span class="method-name">push_scope</span><span class="method-args">(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000148-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000148-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 50</span>
50:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_scope</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span> = <span class="ruby-keyword kw">true</span>)
51:       
52:       <span class="ruby-identifier">stack</span> = (<span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] <span class="ruby-operator">||=</span> [])
53:       
54:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@scope_stack_listener</span>
55:         <span class="ruby-ivar">@scope_stack_listener</span>.<span class="ruby-identifier">notice_first_scope_push</span>(<span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
56:         <span class="ruby-ivar">@scope_stack_listener</span>.<span class="ruby-identifier">notice_push_scope</span> <span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span>
57:       <span class="ruby-keyword kw">end</span>
58:       
59:       <span class="ruby-identifier">scope</span> = <span class="ruby-constant">ScopeStackElement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span>)
60:       <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">scope</span>
61:       
62:       <span class="ruby-identifier">scope</span>
63:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000147" class="method-detail">
        <a name="M000147"></a>

        <div class="method-heading">
          <a href="#M000147" class="method-signature">
          <span class="method-name">remove_scope_stack_listener</span><span class="method-args">(l)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000147-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000147-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 46</span>
46:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_scope_stack_listener</span>(<span class="ruby-identifier">l</span>)
47:       <span class="ruby-ivar">@scope_stack_listener</span> = <span class="ruby-keyword kw">nil</span>
48:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000164" class="method-detail">
        <a name="M000164"></a>

        <div class="method-heading">
          <a href="#M000164" class="method-signature">
          <span class="method-name">reset_stats</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Reset each of the stats, such as when a <a
href="StatsEngine.html#M000143">new</a> passenger instance starts up.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000164-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000164-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 261</span>
261:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset_stats</span> 
262:       <span class="ruby-ivar">@stats_hash</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">reset</span> }
263:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000145" class="method-detail">
        <a name="M000145"></a>

        <div class="method-heading">
          <a href="#M000145" class="method-signature">
          <span class="method-name">spawn_sampler_thread</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000145-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000145-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 24</span>
24:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_sampler_thread</span>
25:       
26:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@sampler_process</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampler_process</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">$$</span> 
27:       
28:       <span class="ruby-comment cmt"># start up a thread that will periodically poll for metric samples</span>
29:       <span class="ruby-ivar">@sampler_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
30:         <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
31:           <span class="ruby-keyword kw">begin</span>
32:             <span class="ruby-identifier">sleep</span> <span class="ruby-constant">POLL_PERIOD</span>
33:             <span class="ruby-identifier">poll</span> <span class="ruby-ivar">@periodic_samplers</span>
34:           <span class="ruby-keyword kw">end</span>
35:         <span class="ruby-keyword kw">end</span>
36:       <span class="ruby-keyword kw">end</span>
37:       <span class="ruby-ivar">@sampler_thread</span>[<span class="ruby-value str">'newrelic_label'</span>] = <span class="ruby-value str">'Sampler Tasks'</span>
38:       <span class="ruby-ivar">@sampler_process</span> = <span class="ruby-identifier">$$</span>
39:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000161" class="method-detail">
        <a name="M000161"></a>

        <div class="method-heading">
          <a href="#M000161" class="method-signature">
          <span class="method-name">start_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000161-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000161-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 238</span>
238:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>
239:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = []
240:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000154" class="method-detail">
        <a name="M000154"></a>

        <div class="method-heading">
          <a href="#M000154" class="method-signature">
          <span class="method-name">transaction_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000154-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000154-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 118</span>
118:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name</span>
119:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>]
120:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000153" class="method-detail">
        <a name="M000153"></a>

        <div class="method-heading">
          <a href="#M000153" class="method-signature">
          <span class="method-name">transaction_name=</span><span class="method-args">(transaction)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000153-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000153-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/stats_engine.rb, line 114</span>
114:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name=</span>(<span class="ruby-identifier">transaction</span>)
115:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>] = <span class="ruby-identifier">transaction</span>
116:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>