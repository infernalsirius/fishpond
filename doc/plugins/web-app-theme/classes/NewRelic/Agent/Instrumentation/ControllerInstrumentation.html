<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: NewRelic::Agent::Instrumentation::ControllerInstrumentation</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::Instrumentation::ControllerInstrumentation</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/vendor/plugins/newrelic_rpm/lib/new_relic/agent/instrumentation/controller_instrumentation_rb.html">
                vendor/plugins/newrelic_rpm/lib/new_relic/agent/instrumentation/controller_instrumentation.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000440">included</a>&nbsp;&nbsp;
      <a href="#M000441">perform_action_with_newrelic_trace</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Module <a href="ControllerInstrumentation/ClassMethods.html" class="link">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethods</a><br />
Module <a href="ControllerInstrumentation/ClassMethodsShim.html" class="link">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethodsShim</a><br />
Module <a href="ControllerInstrumentation/Shim.html" class="link">NewRelic::Agent::Instrumentation::ControllerInstrumentation::Shim</a><br />

    </div>




      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000440" class="method-detail">
        <a name="M000440"></a>

        <div class="method-heading">
          <a href="#M000440" class="method-signature">
          <span class="method-name">included</span><span class="method-args">(clazz)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000440-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000440-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 31</span>
31:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">clazz</span>)
32:       <span class="ruby-identifier">clazz</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">ClassMethods</span>)
33:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000441" class="method-detail">
        <a name="M000441"></a>

        <div class="method-heading">
          <a href="#M000441" class="method-signature">
          <span class="method-name">perform_action_with_newrelic_trace</span><span class="method-args">(*args) {|| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Perform the current action with <a
href="../../../NewRelic.html">NewRelic</a> tracing. Used in a method chain
via aliasing. Call directly if you want to instrument a specifc block as if
it were an action. Pass the block along with the path. The metric is named
according to the action name, or the given path if called directly.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000441-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000441-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 96</span>
 96:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">perform_action_with_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
 97:       <span class="ruby-identifier">agent</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>
 98:       <span class="ruby-identifier">stats_engine</span> = <span class="ruby-identifier">agent</span>.<span class="ruby-identifier">stats_engine</span>
 99:       
100:       <span class="ruby-comment cmt"># Skip instrumentation based on the value of 'do_not_trace' and if </span>
101:       <span class="ruby-comment cmt"># we aren't calling directly with a block.</span>
102:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">block_given?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_filtered?</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">newrelic_read_attr</span>(<span class="ruby-value str">'do_not_trace'</span>))
103:         <span class="ruby-comment cmt"># Tell the dispatcher instrumentation that we ignored this action and it shouldn't</span>
104:         <span class="ruby-comment cmt"># be counted for the overall HTTP operations measurement.</span>
105:         <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:controller_ignored</span>] = <span class="ruby-keyword kw">true</span>
106:         
107:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
108:       <span class="ruby-keyword kw">end</span>
109:       
110:       <span class="ruby-comment cmt"># reset this in case we came through a code path where the top level controller is ignored</span>
111:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:controller_ignored</span>] = <span class="ruby-keyword kw">nil</span>
112:       
113:       <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>
114:       <span class="ruby-identifier">agent</span>.<span class="ruby-identifier">ensure_worker_thread_started</span>
115:       
116:       <span class="ruby-comment cmt"># generate metrics for all all controllers (no scope)</span>
117:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">trace_method_execution_no_scope</span> <span class="ruby-value str">&quot;Controller&quot;</span> <span class="ruby-keyword kw">do</span> 
118:         <span class="ruby-comment cmt"># assuming the first argument, if present, is the action name</span>
119:         <span class="ruby-identifier">path</span> = <span class="ruby-identifier">newrelic_metric_path</span>(<span class="ruby-identifier">args</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>)
120:         <span class="ruby-identifier">controller_metric</span> = <span class="ruby-node">&quot;Controller/#{path}&quot;</span>
121:         
122:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">trace_method_execution_with_scope</span> <span class="ruby-identifier">controller_metric</span>, <span class="ruby-keyword kw">true</span>, <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span> 
123:           <span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">transaction_name</span> = <span class="ruby-identifier">controller_metric</span>
124:           
125:           <span class="ruby-identifier">local_params</span> = (<span class="ruby-identifier">respond_to?</span> <span class="ruby-identifier">:filter_parameters</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">filter_parameters</span>(<span class="ruby-identifier">params</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">params</span>
126:           
127:           <span class="ruby-identifier">agent</span>.<span class="ruby-identifier">transaction_sampler</span>.<span class="ruby-identifier">notice_transaction</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">local_params</span>)
128:           
129:           <span class="ruby-identifier">t</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">utime</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">stime</span>
130:           
131:           <span class="ruby-identifier">failed</span> = <span class="ruby-keyword kw">false</span>
132:           
133:           <span class="ruby-keyword kw">begin</span>
134:             <span class="ruby-comment cmt"># run the action</span>
135:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
136:               <span class="ruby-keyword kw">yield</span>
137:             <span class="ruby-keyword kw">else</span>
138:               <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
139:             <span class="ruby-keyword kw">end</span>
140:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
141:             <span class="ruby-identifier">failed</span> = <span class="ruby-keyword kw">true</span>
142:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
143:           <span class="ruby-keyword kw">ensure</span>
144:             <span class="ruby-identifier">cpu_burn</span> = (<span class="ruby-constant">Process</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">utime</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">stime</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">t</span>
145:             <span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-node">&quot;ControllerCPU/#{path}&quot;</span>).<span class="ruby-identifier">record_data_point</span>(<span class="ruby-identifier">cpu_burn</span>)
146:             <span class="ruby-identifier">agent</span>.<span class="ruby-identifier">transaction_sampler</span>.<span class="ruby-identifier">notice_transaction_cpu_time</span>(<span class="ruby-identifier">cpu_burn</span>)
147:             
148:             <span class="ruby-comment cmt"># do the apdex bucketing</span>
149:             <span class="ruby-comment cmt">#</span>
150:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">is_filtered?</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">newrelic_read_attr</span>(<span class="ruby-value str">'ignore_apdex'</span>))
151:               <span class="ruby-identifier">duration</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start</span>
152:               <span class="ruby-identifier">controller_stat</span> = <span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_custom_stats</span>(<span class="ruby-node">&quot;Apdex/#{path}&quot;</span>, <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">ApdexStats</span>)
153:               <span class="ruby-keyword kw">case</span>
154:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">failed</span>
155:                 <span class="ruby-identifier">apdex_overall_stat</span>.<span class="ruby-identifier">record_apdex_f</span>    <span class="ruby-comment cmt"># frustrated</span>
156:                 <span class="ruby-identifier">controller_stat</span>.<span class="ruby-identifier">record_apdex_f</span>
157:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>[<span class="ruby-value str">'apdex_t'</span>]
158:                 <span class="ruby-identifier">apdex_overall_stat</span>.<span class="ruby-identifier">record_apdex_s</span>    <span class="ruby-comment cmt"># satisfied</span>
159:                 <span class="ruby-identifier">controller_stat</span>.<span class="ruby-identifier">record_apdex_s</span>
160:                 <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">4</span> <span class="ruby-operator">*</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>[<span class="ruby-value str">'apdex_t'</span>]
161:                 <span class="ruby-identifier">apdex_overall_stat</span>.<span class="ruby-identifier">record_apdex_t</span>    <span class="ruby-comment cmt"># tolerating</span>
162:                 <span class="ruby-identifier">controller_stat</span>.<span class="ruby-identifier">record_apdex_t</span>
163:               <span class="ruby-keyword kw">else</span>
164:                 <span class="ruby-identifier">apdex_overall_stat</span>.<span class="ruby-identifier">record_apdex_f</span>    <span class="ruby-comment cmt"># frustrated</span>
165:                 <span class="ruby-identifier">controller_stat</span>.<span class="ruby-identifier">record_apdex_f</span>
166:               <span class="ruby-keyword kw">end</span>
167:             <span class="ruby-keyword kw">end</span>
168:           <span class="ruby-keyword kw">end</span>
169:         <span class="ruby-keyword kw">end</span>
170:       <span class="ruby-keyword kw">end</span>
171:     <span class="ruby-keyword kw">ensure</span>
172:       <span class="ruby-comment cmt"># clear out the name of the traced transaction under all circumstances</span>
173:       <span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">transaction_name</span> = <span class="ruby-keyword kw">nil</span>
174:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>